{
  "name": "SDR Gatekeeper - Inbound Handler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sdr-gatekeeper-inbound",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-receiver",
      "name": "Webhook - Evolution API",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "sdr-gatekeeper-inbound"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Extrai dados relevantes do payload da Evolution API\n// Formato: messages.upsert event\n// ============================================\n\nconst body = $input.first().json.body;\n\n// Ignora mensagens que não são do tipo esperado\nif (!body || !body.data) {\n  return [{ json: { ignore: true, reason: 'no_data' } }];\n}\n\nconst data = body.data;\nconst event = body.event;\n\n// Só processa messages.upsert\nif (event !== 'messages.upsert') {\n  return [{ json: { ignore: true, reason: 'not_message_event', event } }];\n}\n\nconst message = data.message;\nconst key = data.key;\n\n// Ignora mensagens enviadas por nós (outbound)\nif (key.fromMe === true) {\n  return [{ json: { ignore: true, reason: 'from_me' } }];\n}\n\n// Ignora mensagens de grupo\nif (key.remoteJid.includes('@g.us')) {\n  return [{ json: { ignore: true, reason: 'group_message' } }];\n}\n\n// Ignora status broadcasts\nif (key.remoteJid === 'status@broadcast') {\n  return [{ json: { ignore: true, reason: 'status_broadcast' } }];\n}\n\n// Extrai conteúdo da mensagem\nlet messageContent = '';\nlet messageType = 'text';\n\nif (message.conversation) {\n  messageContent = message.conversation;\n} else if (message.extendedTextMessage?.text) {\n  messageContent = message.extendedTextMessage.text;\n} else if (message.imageMessage?.caption) {\n  messageContent = message.imageMessage.caption;\n  messageType = 'image';\n} else if (message.audioMessage) {\n  messageContent = '[audio]';\n  messageType = 'audio';\n} else if (message.documentMessage) {\n  messageContent = '[document]';\n  messageType = 'document';\n} else if (message.reactionMessage) {\n  messageContent = message.reactionMessage.text || '';\n  messageType = 'reaction';\n} else {\n  // Tipo de mensagem não suportado\n  return [{ json: { ignore: true, reason: 'unsupported_message_type' } }];\n}\n\n// Monta payload limpo\nreturn [{\n  json: {\n    ignore: false,\n    remoteJid: key.remoteJid,\n    pushName: data.pushName || '',\n    wamid: key.id,\n    messageContent: messageContent.trim(),\n    messageType,\n    instanceName: body.instance || '',\n    timestamp: data.messageTimestamp || Math.floor(Date.now() / 1000),\n    // Número limpo (sem @s.whatsapp.net)\n    phoneNumber: key.remoteJid.replace('@s.whatsapp.net', '')\n  }\n}];"
      },
      "id": "parse-evolution-payload",
      "name": "Parse Evolution Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-ignore",
              "leftValue": "={{ $json.ignore }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-valid-messages",
      "name": "Filtro - Mensagem Válida?",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, status, message_count, fastapi_session_id, clinic_name\nFROM conversations\nWHERE remote_jid = '{{ $json.remoteJid }}'\n  AND status IN ('active', 'stalled')\nORDER BY created_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "lookup-conversation",
      "name": "Supabase - Busca Conversa",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [930, 300],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge dados da mensagem com dados da conversa existente\nconst message = $('Filtro - Mensagem Válida?').first().json;\nconst dbResults = $input.first().json;\n\nlet conversationId = null;\nlet isNewConversation = true;\nlet fastapiSessionId = null;\nlet currentStatus = null;\n\n// Verifica se existe conversa ativa\nif (dbResults && dbResults.id) {\n  conversationId = dbResults.id;\n  isNewConversation = false;\n  fastapiSessionId = dbResults.fastapi_session_id;\n  currentStatus = dbResults.status;\n}\n\nreturn [{\n  json: {\n    ...message,\n    conversationId,\n    isNewConversation,\n    fastapiSessionId,\n    currentStatus\n  }\n}];"
      },
      "id": "merge-context",
      "name": "Merge - Contexto da Conversa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1150, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-new",
              "leftValue": "={{ $json.isNewConversation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-new-conversation",
      "name": "Nova Conversa?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1370, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversations (remote_jid, push_name, status, evolution_instance, message_count, last_message_at)\nVALUES (\n  '{{ $json.remoteJid }}',\n  '{{ $json.pushName }}',\n  'active',\n  '{{ $json.instanceName }}',\n  1,\n  NOW()\n)\nRETURNING id, status;",
        "options": {}
      },
      "id": "create-conversation",
      "name": "Supabase - Cria Conversa",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1600, 200],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversations\nSET message_count = message_count + 1,\n    last_message_at = NOW(),\n    status = CASE WHEN status = 'stalled' THEN 'active' ELSE status END,\n    expires_at = NOW() + INTERVAL '4 hours'\nWHERE id = '{{ $json.conversationId }}'\nRETURNING id, status;",
        "options": {}
      },
      "id": "update-conversation",
      "name": "Supabase - Atualiza Conversa",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1600, 400],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepara payload unificado para o FastAPI, independente de ser nova ou existente\nconst messageData = $('Merge - Contexto da Conversa').first().json;\nconst dbResult = $input.first().json;\n\nconst conversationId = dbResult.id || messageData.conversationId;\n\nreturn [{\n  json: {\n    conversationId,\n    remoteJid: messageData.remoteJid,\n    pushName: messageData.pushName,\n    messageContent: messageData.messageContent,\n    messageType: messageData.messageType,\n    phoneNumber: messageData.phoneNumber,\n    wamid: messageData.wamid,\n    isNewConversation: messageData.isNewConversation,\n    fastapiSessionId: messageData.fastapiSessionId,\n    instanceName: messageData.instanceName\n  }\n}];"
      },
      "id": "prepare-fastapi-payload",
      "name": "Prepara Payload FastAPI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1860, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO messages (conversation_id, direction, content, message_type, wamid)\nVALUES (\n  '{{ $json.conversationId }}',\n  'inbound',\n  {{ $json.messageContent.toJSON() }},\n  '{{ $json.messageType }}',\n  '{{ $json.wamid }}'\n);",
        "options": {}
      },
      "id": "save-inbound-message",
      "name": "Supabase - Salva Msg Inbound",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2080, 160],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ade.easyscale.co/v1/sdr/gatekeeper",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.FASTAPI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"conversation_id\": \"{{ $json.conversationId }}\",\n  \"remote_jid\": \"{{ $json.remoteJid }}\",\n  \"sender_name\": \"{{ $json.pushName }}\",\n  \"message\": \"{{ $json.messageContent }}\",\n  \"message_type\": \"{{ $json.messageType }}\",\n  \"phone_number\": \"{{ $json.phoneNumber }}\",\n  \"is_new_conversation\": {{ $json.isNewConversation }},\n  \"session_id\": {{ $json.fastapiSessionId ? '\"' + $json.fastapiSessionId + '\"' : 'null' }}\n}",
        "options": {
          "timeout": 30000,
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "call-fastapi",
      "name": "HTTP - FastAPI Gatekeeper",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2080, 440],
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsCode": "// Processa resposta do FastAPI\nconst response = $input.first().json;\nconst messageData = $('Prepara Payload FastAPI').first().json;\n\nconst body = response.body || response;\n\n// Resposta esperada do FastAPI:\n// {\n//   \"reply\": \"Mensagem para enviar ao atendente\",\n//   \"session_id\": \"abc-123\",\n//   \"intent\": \"greeting|asking_decisor|decisor_received|objection|...\",\n//   \"confidence\": 0.95,\n//   \"conversation_status\": \"active|decisor_captured|rejected\",\n//   \"decisor_info\": { \"name\": \"...\", \"phone\": \"...\", \"email\": \"...\", \"role\": \"...\" }\n// }\n\nconst reply = body.reply || body.message || '';\nconst sessionId = body.session_id || null;\nconst intent = body.intent || 'unknown';\nconst confidence = body.confidence || 0;\nconst conversationStatus = body.conversation_status || 'active';\nconst decisorInfo = body.decisor_info || null;\n\nreturn [{\n  json: {\n    conversationId: messageData.conversationId,\n    remoteJid: messageData.remoteJid,\n    instanceName: messageData.instanceName,\n    reply,\n    sessionId,\n    intent,\n    confidence,\n    conversationStatus,\n    decisorInfo,\n    hasReply: reply.length > 0\n  }\n}];"
      },
      "id": "process-fastapi-response",
      "name": "Processa Resposta FastAPI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2310, 440]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualiza conversa com dados retornados pelo FastAPI\nUPDATE conversations\nSET\n  fastapi_session_id = COALESCE('{{ $json.sessionId }}', fastapi_session_id),\n  status = '{{ $json.conversationStatus }}',\n  decisor_name = {{ $json.decisorInfo ? \"'\" + ($json.decisorInfo.name || '') + \"'\" : 'decisor_name' }},\n  decisor_phone = {{ $json.decisorInfo ? \"'\" + ($json.decisorInfo.phone || '') + \"'\" : 'decisor_phone' }},\n  decisor_email = {{ $json.decisorInfo ? \"'\" + ($json.decisorInfo.email || '') + \"'\" : 'decisor_email' }},\n  decisor_role = {{ $json.decisorInfo ? \"'\" + ($json.decisorInfo.role || '') + \"'\" : 'decisor_role' }}\nWHERE id = '{{ $json.conversationId }}';",
        "options": {}
      },
      "id": "update-conversation-status",
      "name": "Supabase - Atualiza Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2540, 300],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO messages (conversation_id, direction, content, message_type, agent_intent, agent_confidence)\nVALUES (\n  '{{ $json.conversationId }}',\n  'outbound',\n  {{ $json.reply.toJSON() }},\n  'text',\n  '{{ $json.intent }}',\n  {{ $json.confidence }}\n);",
        "options": {}
      },
      "id": "save-outbound-message",
      "name": "Supabase - Salva Msg Outbound",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2540, 500],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-has-reply",
              "leftValue": "={{ $json.hasReply }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-has-reply",
      "name": "Tem Resposta?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2770, 440]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $env.EVOLUTION_INSTANCE_NAME }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.EVOLUTION_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.remoteJid }}\",\n  \"text\": {{ $json.reply.toJSON() }}\n}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "send-whatsapp-reply",
      "name": "Evolution API - Envia Resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3010, 340],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ status: 'ok', processed: true }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "webhook-response-ok",
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [3240, 340]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ status: 'ok', processed: false, reason: 'no_reply_needed' }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "webhook-response-no-reply",
      "name": "Respond - Sem Resposta",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [3010, 560]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ status: 'ok', ignored: true, reason: $json.reason || 'filtered' }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "webhook-response-ignored",
      "name": "Respond - Ignorada",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [700, 500]
    },
    {
      "parameters": {
        "jsCode": "// Log de evento: decisor capturado\nconst data = $('Processa Resposta FastAPI').first().json;\n\nif (data.conversationStatus === 'decisor_captured' && data.decisorInfo) {\n  return [{\n    json: {\n      conversationId: data.conversationId,\n      eventType: 'decisor_info_received',\n      eventData: JSON.stringify(data.decisorInfo)\n    }\n  }];\n}\n\n// Sem evento especial\nreturn [];"
      },
      "id": "check-decisor-event",
      "name": "Evento - Decisor Capturado?",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3010, 720]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversation_events (conversation_id, event_type, event_data)\nVALUES (\n  '{{ $json.conversationId }}',\n  '{{ $json.eventType }}',\n  '{{ $json.eventData }}'::jsonb\n);",
        "options": {}
      },
      "id": "save-event",
      "name": "Supabase - Salva Evento",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [3240, 720],
      "credentials": {
        "postgres": {
          "id": "SUPABASE_CREDENTIALS_ID",
          "name": "Supabase PostgreSQL"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Evolution API": {
      "main": [
        [
          {
            "node": "Parse Evolution Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Evolution Payload": {
      "main": [
        [
          {
            "node": "Filtro - Mensagem Válida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro - Mensagem Válida?": {
      "main": [
        [
          {
            "node": "Supabase - Busca Conversa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond - Ignorada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Busca Conversa": {
      "main": [
        [
          {
            "node": "Merge - Contexto da Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge - Contexto da Conversa": {
      "main": [
        [
          {
            "node": "Nova Conversa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nova Conversa?": {
      "main": [
        [
          {
            "node": "Supabase - Cria Conversa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Atualiza Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Cria Conversa": {
      "main": [
        [
          {
            "node": "Prepara Payload FastAPI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Atualiza Conversa": {
      "main": [
        [
          {
            "node": "Prepara Payload FastAPI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepara Payload FastAPI": {
      "main": [
        [
          {
            "node": "Supabase - Salva Msg Inbound",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP - FastAPI Gatekeeper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - FastAPI Gatekeeper": {
      "main": [
        [
          {
            "node": "Processa Resposta FastAPI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processa Resposta FastAPI": {
      "main": [
        [
          {
            "node": "Supabase - Atualiza Status",
            "type": "main",
            "index": 0
          },
          {
            "node": "Supabase - Salva Msg Outbound",
            "type": "main",
            "index": 0
          },
          {
            "node": "Tem Resposta?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Evento - Decisor Capturado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Resposta?": {
      "main": [
        [
          {
            "node": "Evolution API - Envia Resposta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond - Sem Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution API - Envia Resposta": {
      "main": [
        [
          {
            "node": "Respond OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evento - Decisor Capturado?": {
      "main": [
        [
          {
            "node": "Supabase - Salva Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "name": "SDR",
      "id": "1"
    },
    {
      "name": "Gatekeeper",
      "id": "2"
    },
    {
      "name": "Production",
      "id": "3"
    }
  ]
}
